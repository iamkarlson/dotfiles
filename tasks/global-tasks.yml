# yaml-language-server: $schema=https://taskfile.dev/schema.json
# https://taskfile.dev

version: "3"

#dotenv: ["{{.DOTFILES}}/tasks/taskfile.env"]
dotenv: ["/home/{{.USERNAME}}/src/dotfiles/tasks/taskfile.env"]

vars:
  VSCODE_CONFIG_DIR: "{{.HOME}}/.config/vscode_project_configs"
  GITHUB_CONFIG_DIR: "{{.HOME}}/.config/github_project_configs"
  PROJECT_NAME: "{{base .USER_WORKING_DIR}}"
  PROJECT_CONFIG_DIR: "{{.VSCODE_CONFIG_DIR}}/{{.PROJECT_NAME}}"
  PROJECT_GITHUB_CONFIG_DIR: "{{.GITHUB_CONFIG_DIR}}/{{.PROJECT_NAME}}"
  LOCAL_VSCODE_DIR: ".vscode"
  LOCAL_GITHUB_DIR: ".github"

includes:
  private:
    taskfile: ./private-tasks.yml
    flatten: true

tasks:
  init:
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - go-task --init
      #- mv Taskfile.yml taskfile.yml
      #
      - |
        echo "# yaml-language-server: \$schema=https://taskfile.dev/schema.json"  > taskfile.yml
      - cat Taskfile.yml >>taskfile.yml
      - rm Taskfile.yml
    silent: false

  change-theme:
    cmds:
      - |
        ls /usr/share/alacritty/themes/*.toml |\
          xargs -n1 basename |\
          sed 's/.toml$//' |\
          fzf --preview 'theme={}; sed -i "s|alacritty/themes/.*\.toml|alacritty/themes/$theme.toml|" /home/iamkarlson/src/dotfiles/alacritty/alacritty.toml; echo $theme'
  gcloud:configuration:
    cmds:
      - gcloud config configurations create {{.GCLOUD_CONFIGURATION}}
      - gcloud config configurations activate {{.GCLOUD_CONFIGURATION}}

  gcloud:account:
    cmds:
      - gcloud config set account {{.GCLOUD_ACCOUNT}}

  gcloud:project:
    cmds:
      - gcloud config set project {{.GCLOUD_PROJECT}}
      - gcloud auth application-default login
      - gcloud auth application-default set-quota-project {{.GCLOUD_PROJECT}}

  select-and-run:
    desc: "Interactively select and run a global task"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        # Get all tasks and filter for global ones
        echo "üîç Fetching global tasks..."

        # Get task list as JSON
        task_json=$(go-task -g --list-all --json)
        #echo "Raw JSON: $task_json"

        # Format tasks for fzf display
        formatted_tasks=$(echo "$task_json" | jq -r '.tasks[] | if .desc and .desc != "" then "\(.name): \(.desc)" else .name end')
        #echo "Formatted tasks:"
        #echo "$formatted_tasks"

        # Let user select task
        selected_task=$(echo "$formatted_tasks" | fzf --prompt="Select global task: " --height=40% --border)
        #echo "Selected task: $selected_task"

        if [ -n "$selected_task" ]; then
          task_name=$(echo "$selected_task" | sed 's/: .*//')
          echo "üöÄ About to run task: $task_name"
          read -p "Press ENTER to continue, any other key to cancel: " confirm
          if [[ -z "$confirm" ]]; then
            echo "Running task: $task_name"
            go-task -g "$task_name"
          else
            echo "‚ùå Task cancelled"
            exit 0
          fi
        else
          echo "‚ùå No task selected"
        fi

  new-sketch:
    dir: "{{.HOME}}/src/sketches"
    cmds:
      - ls -la
    silent: false
  _ensure-config-dir:
    internal: true
    dir: "{{.USER_WORKING_DIR}}"
    status:
      - test -d {{.CONFIG_DIR}}
    cmds:
      - echo "Ensuring config directory exists at {{.CONFIG_DIR}}"
      - mkdir -p {{.CONFIG_DIR}}

  _sync-logic:
    internal: true
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        # Check if local directory exists
        if [ -d "{{.LOCAL_DIR}}" ]; then
          # Local directory exists
          if [ -d "{{.SAVED_DIR}}" ]; then
            # Both exist - compare files
            echo "üîç Comparing {{.CONFIG_TYPE}} configs for {{.PROJECT_NAME}}..."

            differences_found=false

            if [ "{{.SYNC_MODE}}" = "file-specific" ]; then
              # Check each important file for VS Code
              for file in tasks.json launch.json settings.json extensions.json; do
                local_file="{{.LOCAL_DIR}}/$file"
                remote_file="{{.SAVED_DIR}}/$file"

                if [ -f "$local_file" ] && [ -f "$remote_file" ]; then
                  if ! cmp -s "$local_file" "$remote_file"; then
                    differences_found=true
                    break
                  fi
                elif [ -f "$local_file" ] && [ ! -f "$remote_file" ]; then
                  differences_found=true
                  break
                elif [ ! -f "$local_file" ] && [ -f "$remote_file" ]; then
                  differences_found=true
                  break
                fi
              done
            else
              # Use diff to compare entire directories
              if ! diff -r "{{.LOCAL_DIR}}" "{{.SAVED_DIR}}" >/dev/null 2>&1; then
                differences_found=true
              fi
            fi

            # If differences found, show diff and original behavior
            if [ "$differences_found" = true ]; then
              # Show diff output first
              echo "üìÑ Showing differences:"
              if [ "{{.SYNC_MODE}}" = "file-specific" ]; then
                for file in tasks.json launch.json settings.json extensions.json; do
                  local_file="{{.LOCAL_DIR}}/$file"
                  remote_file="{{.SAVED_DIR}}/$file"
                  if [ -f "$local_file" ] && [ -f "$remote_file" ]; then
                    if ! cmp -s "$local_file" "$remote_file"; then
                      echo "--- Differences in $file ---"
                      diff -u "$remote_file" "$local_file" || true
                      echo ""
                    fi
                  elif [ -f "$local_file" ] && [ ! -f "$remote_file" ]; then
                    echo "üì§ New file: $file (local only)"
                  elif [ ! -f "$local_file" ] && [ -f "$remote_file" ]; then
                    echo "üì• Missing file: $file (saved only)"
                  fi
                done
              else
                diff -r "{{.SAVED_DIR}}" "{{.LOCAL_DIR}}" || true
              fi
              echo ""
              
              # Show instructions
              echo "‚ö†Ô∏è  Run 'task -g {{.PUSH_TASK}}' to update saved config or 'task -g {{.PULL_TASK}}' to use saved config"
            else
              echo "‚úÖ All good, {{.CONFIG_TYPE}} configs are safe - local and saved configurations match perfectly"
            fi
          else
            # Local exists, remote doesn't - copy to remote
            echo "üì§ Backing up {{.CONFIG_TYPE}} config for {{.PROJECT_NAME}}..."
            cp -r "{{.LOCAL_DIR}}" "{{.SAVED_DIR}}"
            echo "‚úÖ Config backed up to {{.SAVED_DIR}}"
          fi
        else
          # No local directory
          if [ -d "{{.SAVED_DIR}}" ]; then
            # Remote exists, local doesn't - copy from remote
            echo "üì• Restoring {{.CONFIG_TYPE}} config for {{.PROJECT_NAME}}..."
            cp -r "{{.SAVED_DIR}}" "{{.LOCAL_DIR}}"
            echo "‚úÖ Config restored from {{.SAVED_DIR}}"
          else
            # Neither exists
            echo "‚ÑπÔ∏è  No {{.CONFIG_TYPE}} config found for {{.PROJECT_NAME}}"
          fi
        fi

  vscode:push:
    desc: "Force push local VS Code config to saved location"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - task: _ensure-config-dir
        vars:
          CONFIG_DIR: "{{.VSCODE_CONFIG_DIR}}"
      - |
        if [ -d "{{.LOCAL_VSCODE_DIR}}" ]; then
          echo "üì§ Pushing VS Code config for {{.PROJECT_NAME}}..."
          rm -r "{{.PROJECT_CONFIG_DIR}}"
          cp -r "{{.LOCAL_VSCODE_DIR}}" "{{.PROJECT_CONFIG_DIR}}"
          echo "‚úÖ Config pushed to {{.PROJECT_CONFIG_DIR}}"
        else
          echo "‚ùå No local .vscode directory found"
          exit 1
        fi

  vscode:pull:
    desc: "Force pull saved VS Code config to local project"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        if [ -d "{{.PROJECT_CONFIG_DIR}}" ]; then
          echo "üì• Pulling VS Code config for {{.PROJECT_NAME}}..."
          if [-d "{{.LOCAL_VSCODE_DIR}}" ]; then
            echo "Removing existing local .vscode directory: {{.LOCAL_VSCODE_DIR}}"
            rm -r "{{.LOCAL_VSCODE_DIR}}"
          fi
          cp -r "{{.PROJECT_CONFIG_DIR}}" "{{.LOCAL_VSCODE_DIR}}"
          echo "‚úÖ Config pulled from {{.PROJECT_CONFIG_DIR}}"
        else
          echo "‚ùå No saved config found for {{.PROJECT_NAME}}"
          exit 1
        fi

  vscode:status:
    desc: "Show VS Code config sync status"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        echo "üìÅ Project: {{.PROJECT_NAME}}"
        echo "üìÇ Local config: {{.LOCAL_VSCODE_DIR}}"
        echo "üíæ Saved config: {{.PROJECT_CONFIG_DIR}}"
        echo ""

        if [ -d "{{.LOCAL_VSCODE_DIR}}" ]; then
          echo "Current folder: $PWD"
          echo "‚úÖ Local .vscode directory exists: {{.LOCAL_VSCODE_DIR}}"
          ls -la "{{.LOCAL_VSCODE_DIR}}"
        else
          echo "‚ùå No local .vscode directory"
        fi

        echo ""

        if [ -d "{{.PROJECT_CONFIG_DIR}}" ]; then
          echo "‚úÖ Saved config exists in {{.PROJECT_CONFIG_DIR}}"
          ls -la "{{.PROJECT_CONFIG_DIR}}"
        else
          echo "‚ùå No saved config"
        fi

  vscode:clean:
    desc: "Remove saved VS Code config for this project"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    prompt: "This will permanently delete saved VS Code config for {{.PROJECT_NAME}}. Continue?"
    cmds:
      - |
        if [ -d "{{.PROJECT_CONFIG_DIR}}" ]; then
          rm -r "{{.PROJECT_CONFIG_DIR}}"
          echo "üóëÔ∏è Removed saved config for {{.PROJECT_NAME}}"
        else
          echo "‚ÑπÔ∏è  No saved config to remove"
        fi

  vscode:list:
    desc: "List all saved VS Code project configurations"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        if [ -d "{{.VSCODE_CONFIG_DIR}}" ]; then
          echo "üíæ Saved VS Code configurations:"
          ls -la "{{.VSCODE_CONFIG_DIR}}"
        else
          echo "‚ÑπÔ∏è  No saved configurations found"
        fi

  vscode:sync:
    desc: "Sync VS Code configuration files between project and global config directory"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - task: _ensure-config-dir
        vars:
          CONFIG_DIR: "{{.VSCODE_CONFIG_DIR}}"
      - task: _sync-logic
        vars:
          LOCAL_DIR: "{{.LOCAL_VSCODE_DIR}}"
          SAVED_DIR: "{{.PROJECT_CONFIG_DIR}}"
          CONFIG_TYPE: "VS Code"
          PUSH_TASK: "vscode:push"
          PULL_TASK: "vscode:pull"
          SYNC_MODE: "file-specific"

  github:sync:
    desc: "Sync GitHub configuration files between project and global config directory"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - task: _ensure-config-dir
        vars:
          CONFIG_DIR: "{{.GITHUB_CONFIG_DIR}}"
      - task: _sync-logic
        vars:
          LOCAL_DIR: "{{.LOCAL_GITHUB_DIR}}"
          SAVED_DIR: "{{.PROJECT_GITHUB_CONFIG_DIR}}"
          CONFIG_TYPE: "GitHub"
          PUSH_TASK: "github:push"
          PULL_TASK: "github:pull"
          SYNC_MODE: "directory"

  github:push:
    desc: "Force push local GitHub config to saved location"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - task: _ensure-config-dir
        vars:
          CONFIG_DIR: "{{.GITHUB_CONFIG_DIR}}"
      - |
        if [ -d "{{.LOCAL_GITHUB_DIR}}" ]; then
          echo "üì§ Pushing GitHub config for {{.PROJECT_NAME}}..."
          rm -r "{{.PROJECT_GITHUB_CONFIG_DIR}}"
          cp -r "{{.LOCAL_GITHUB_DIR}}" "{{.PROJECT_GITHUB_CONFIG_DIR}}"
          echo "‚úÖ Config pushed to {{.PROJECT_GITHUB_CONFIG_DIR}}"
        else
          echo "‚ùå No local .github directory found"
          exit 1
        fi

  github:pull:
    desc: "Force pull saved GitHub config to local project"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        if [ -d "{{.PROJECT_GITHUB_CONFIG_DIR}}" ]; then
          echo "üì• Pulling GitHub config for {{.PROJECT_NAME}}..."
          if [-d "{{.LOCAL_GITHUB_DIR}}" ]; then
            echo "Removing existing local .vscode directory: {{.LOCAL_GITHUB_DIR}}"
            rm -r "{{.LOCAL_GITHUB_DIR}}"
          fi
          cp -r "{{.PROJECT_GITHUB_CONFIG_DIR}}" "{{.LOCAL_GITHUB_DIR}}"
          echo "‚úÖ Config pulled from {{.PROJECT_GITHUB_CONFIG_DIR}}"
        else
          echo "‚ùå No saved GitHub config found for {{.PROJECT_NAME}}"
          exit 1
        fi

  github:status:
    desc: "Show GitHub config sync status"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        echo "üìÅ Project: {{.PROJECT_NAME}}"
        echo "üìÇ Local config: {{.LOCAL_GITHUB_DIR}}"
        echo "üíæ Saved config: {{.PROJECT_GITHUB_CONFIG_DIR}}"
        echo ""

        if [ -d "{{.LOCAL_GITHUB_DIR}}" ]; then
          echo "‚úÖ Local .github directory exists: {{.LOCAL_GITHUB_DIR}}"
          find "{{.LOCAL_GITHUB_DIR}}" -type f -exec ls -la {} \;
        else
          echo "‚ùå No local .github directory"
        fi

        echo ""

        if [ -d "{{.PROJECT_GITHUB_CONFIG_DIR}}" ]; then
          echo "‚úÖ Saved GitHub config exists in {{.PROJECT_GITHUB_CONFIG_DIR}}"
          find "{{.PROJECT_GITHUB_CONFIG_DIR}}" -type f -exec ls -la {} \;
        else
          echo "‚ùå No saved GitHub config"
        fi

  github:clean:
    desc: "Remove saved GitHub config for this project"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    prompt: "This will permanently delete saved GitHub config for {{.PROJECT_NAME}}. Continue?"
    cmds:
      - |
        if [ -d "{{.PROJECT_GITHUB_CONFIG_DIR}}" ]; then
          rm -r "{{.PROJECT_GITHUB_CONFIG_DIR}}"
          echo "üóëÔ∏è  Removed saved GitHub config for {{.PROJECT_NAME}}"
        else
          echo "‚ÑπÔ∏è  No saved GitHub config to remove"
        fi

  github:list:
    desc: "List all saved GitHub project configurations"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        if [ -d "{{.GITHUB_CONFIG_DIR}}" ]; then
          echo "üíæ Saved GitHub configurations:"
          ls -la "{{.GITHUB_CONFIG_DIR}}"
        else
          echo "‚ÑπÔ∏è  No saved GitHub configurations found"
        fi

  sync:all:
    desc: "Sync both VS Code and GitHub configurations"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - task: vscode:sync
      - task: github:sync

  sync:remote:
    desc: "Sync config directories with remote host"
    silent: false
    vars:
      CONFIG_DIRS: "vscode_project_configs,github_project_configs"
      TEMP_DIR: "/tmp/config_sync_{{.USER}}_$$"
    cmds:
      - |
        echo "hosts: {{.HOSTS}}"
      - "{{.DOTFILES}}/tasks/sync_remote_configs.sh {{.HOSTS}} {{.CONFIG_DIRS}} {{.TEMP_DIR}}"
    preconditions:
      - sh: 'ssh beryl "echo \$HOST"'
        msg: "Target host is not reachable, halting sync"

  docker:compose:stop-all:
    desc: "Stops all docker compose projects"
    silent: false
    cmds:
      - docker compose ls -q | xargs -r -I {} docker compose -p {} down

  branch:list:
    desc: "List all branches with upstream tracking info"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - "{{.DOTFILES}}/tasks/scripts/branches-list.sh"

  branch:switch:
    desc: "Interactive branch switching with fzf"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        set -euo pipefail

        # Get branch list and let user select
        selected=$({{.DOTFILES}}/tasks/scripts/branches-list.sh | \
          fzf \
            --delimiter=$'\t' \
            --with-nth=1 \
            --preview 'git log --oneline --graph --date=short --color=always --pretty="format:%C(auto)%cd %h%d %s" {2}')

        # Extract checkout ref (second column)
        checkout_ref=$(echo "$selected" | cut -f2)

        # Checkout the branch
        git checkout "$checkout_ref"

  git:worktree:
    desc: "Create and switch to a git worktree for a branch (interactive)"
    dir: "{{.USER_WORKING_DIR}}"
    silent: true
    cmds:
      - |
        # Get repo name
        REPO_NAME="${PWD##*/}"
        WORKTREE_BASE="../${REPO_NAME}-worktrees"

        # Use the same branch listing as branch:switch, with --print-query to allow typing new branch names
        SELECTION=$({{.DOTFILES}}/tasks/scripts/branches-list.sh | fzf \
          --delimiter='\t' \
          --with-nth=1 \
          --print-query \
          --prompt="Select or type branch name: " \
          --preview 'git log --oneline --graph --date=short --color=always --pretty="format:%C(auto)%cd %h%d %s" {2} 2>/dev/null')

        if [ -z "$SELECTION" ]; then
          echo "‚ùå No branch selected"
          exit 1
        fi

        # Get the last line (the actual selection or typed value)
        LAST_LINE=$(echo "$SELECTION" | tail -1)

        if [ -z "$LAST_LINE" ]; then
          echo "‚ùå No branch selected"
          exit 1
        fi

        # If user selected from list, extract the checkout ref (column 2)
        # If user typed a new name, LAST_LINE won't have a tab
        if echo "$LAST_LINE" | grep -q $'\t'; then
          # Selected from list - extract checkout ref
          CHECKOUT_REF=$(echo "$LAST_LINE" | cut -f2)
          # Get branch name without origin/ prefix for worktree directory
          BRANCH_NAME="${CHECKOUT_REF#origin/}"
        else
          # Typed new branch name
          BRANCH_NAME="$LAST_LINE"
          CHECKOUT_REF="$LAST_LINE"
        fi

        # Check if worktree already exists
        if [ -d "$WORKTREE_BASE/$BRANCH_NAME" ]; then
          echo "‚ö†Ô∏è  Worktree already exists at: $WORKTREE_BASE/$BRANCH_NAME"
          echo "üìÅ To switch to it, run: cd $WORKTREE_BASE/$BRANCH_NAME"
          exit 0
        fi

        # Create worktree base directory if it doesn't exist
        mkdir -p "$WORKTREE_BASE"

        # Check if branch exists (local or remote)
        if git rev-parse --verify "$CHECKOUT_REF" >/dev/null 2>&1; then
          # Branch exists
          echo "üìÇ Creating worktree for existing branch: $BRANCH_NAME"
          git worktree add "$WORKTREE_BASE/$BRANCH_NAME" "$CHECKOUT_REF"
        else
          # Branch doesn't exist - create it
          echo "üÜï Creating new branch and worktree: $BRANCH_NAME"
          git worktree add -b "$BRANCH_NAME" "$WORKTREE_BASE/$BRANCH_NAME"
        fi

        WORKTREE_PATH="$WORKTREE_BASE/$BRANCH_NAME"
        echo ""
        echo "‚úÖ Worktree created at: $WORKTREE_PATH"
        echo "üìÅ To switch to it, run: cd $WORKTREE_PATH"
